<div class="general-style">
  <div class="container mt-4">
    <div class="card d-flex flex-row align-items-center justify-content-between gap-3 mb-4">
        <div class="d-flex flex-row align-items-center">
          <%= image_tag @exchange.wanted_manga.db_manga.image_url, class: "img-cover-fixed", alt: @exchange.wanted_manga.db_manga.title %>
        </div>
        <h1> VS </h1>
      <% if @exchange.offered_manga %>
        <div class="d-flex flex-row align-items-center">
          <%= image_tag @exchange.offered_manga.db_manga.image_url, class: "img-cover-fixed", alt: @exchange.offered_manga.db_manga.title  %>
        </div>
      <% end %>
    </div>

    <div class="card mb-4">
      <!-- Nom et message -->
      <h5>Détails de l'échange</h5>
      <p class="mb-1"><i class="fa-solid fa-user"></i>  <%= @exchange.initiator.username %></p>
      <p class="mb-1"><i class="fa-solid fa-message"></i> <%= @exchange.initial_message %></p>

      <% if @exchange.scheduled_at.present? %>
        <p class="mb-1"><strong>Échange prévu le :</strong> <%= l(@exchange.scheduled_at, format: :long) %></p>
      <% else %>
        <p class="mb-1"><i class="fa-solid fa-calendar"></i> Aucune date prévue !</p>
      <% end %>

      <!-- Afficher le status -->
      <div class="my-0">
      <% if @exchange.status == 'accepted' %>
        <p class="badge rounded-pill bg-success"><%= @exchange.status.humanize %></p>
      <% elsif @exchange.status == 'refused' %>
        <p class="badge rounded-pill bg-danger"><%= @exchange.status.humanize %></p>
      <% else %>
        <p class="badge rounded-pill bg-secondary"><%= @exchange.status.humanize %></p>
      <% end %>
      </div>
    </div>

    <div class="card">
    <% if @exchange.status == "accepted" && (@exchange.initiator == current_user || @exchange.recipient == current_user) %>
      <div class="">
        <% if @exchange.scheduled_at.present?%>
          <h5>Modifie la date d’échange</h5>
        <% else %>
          <h5>Choisis la date d’échange</h5>
        <% end %>
        <%= form_with model: @exchange, url: set_date_exchange_path(@exchange), method: :patch, local: true do |f| %>
          <div class="mb-2">
            <%= f.date_field :scheduled_at, class: "form-control", value: @exchange.scheduled_at %>
          </div>
          <%= f.submit "Enregistrer la date", class: "btn btn-manga-primary" %>
        <% end %>
      </div>
    <% end %>
    </div>

    <% if @exchange.status == "pending" && @exchange.recipient != current_user%>
      <%= link_to "Ouvrir le chat", chat_path(@exchange.chat), class: "btn btn-info" %>
    <% elsif @exchange.status == "pending" && @exchange.recipient == current_user%>
      <%= link_to "Choisir un manga en échange", edit_exchange_path(@exchange), class: "btn btn-primary" %>
      <%= button_to "Refuser l'échange", update_status_exchange_path(@exchange, status: "refused"), method: :patch, class: "btn btn-danger" %>
      <%= link_to "Ouvrir le chat", chat_path(@exchange.chat), class: "btn btn-info" %>
    <% end %>

    <% %>
  </div>
</div>

<!-- si le user propose l'échange et c'est pending -- pas de boutons -->
<!-- si l'autre user recoit l'échange, il doit choisir un manga -- bouton choisir ou bouton refuser -->
<!-- si le user choisi un manga -- demande accepté -->
<!-- si demande accepté -- proposer une date et ouvrir le chat -->
